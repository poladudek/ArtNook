<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel u≈ºytkownika - ArtNook</title>
    <link rel="stylesheet" href="styles/style.css">

    <style>
        .center-message {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #ccc;
            min-height: 120px;
        }
    </style>
</head>
<body>

    <nav>
        <a class="name" href="index.html">ART NOOK</a>
        <div class="tabs">
            <a href="screenings.html">Repertuar</a>
             <div class="user-menu">
    <button id="userBtn" class="user-btn">üë§</button>

    <div id="userDropdown" class="user-dropdown">
        <a href="user.html">Moje rezerwacje</a>
        <button id="logoutBtn">Wyloguj siƒô</button>
    </div>
</div>

        </div>
    </nav>

    <main style="padding: 40px 60px;">
        <h1 class="section-title">Panel u≈ºytkownika</h1>
        <p style="color:#ccc; margin-top:8px;">Twoje nadchodzƒÖce rezerwacje:</p>

        <div id="bookingsList" style="margin-top:18px;">
            <p class="loading">≈Åadowanie rezerwacji...</p>
        </div>
    </main>

    <footer>
        <p>&copy; 2026 ArtNook. Wszystkie prawa zastrze≈ºone.</p>
    </footer>

<script>
    function updateAuthLink() {
        const token = localStorage.getItem('token');
        const userMenu = document.querySelector('.user-menu');
        const loginLink = document.getElementById('authLink');
        if (token) {
            if (loginLink) loginLink.style.display = 'none';
            if (userMenu) userMenu.style.display = 'block';
        } else {
            if (loginLink) loginLink.style.display = 'inline';
            if (userMenu) userMenu.style.display = 'none';
        }
  }

    async function loadBookings() {
        const token = localStorage.getItem('token');
        const container = document.getElementById('bookingsList');
        if (!token) {
            container.innerHTML = '<div class="center-message">Musisz siƒô <a href="login.html">zalogowaƒá</a>, aby zobaczyƒá rezerwacje.</div>';
            updateAuthLink();
            return;
        }
        try {
            const res = await fetch('http://localhost:3000/api/bookings/mine', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) {
                container.innerHTML = '<div class="center-message">B≈ÇƒÖd ≈Çadowania rezerwacji. Spr√≥buj ponownie.</div>';
                return;
            }

            const bookings = await res.json();
            container.innerHTML = '';
            function parseTime(s) {
                if (!s) return null;
                if (typeof s === 'string') {
                    let t = s.trim();
                    if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/.test(t)) t = t.replace(' ', 'T');
                    return new Date(t);
                }
                return new Date(s);
            }

            const now = new Date();
            const upcoming = [];
            const past = [];

            bookings.forEach(b => {
                const t = new Date(b.start_time.replace(' ', 'T'));
                if (t && !isNaN(t) && t > now) upcoming.push({ b, t });
            });

            upcoming.sort((a, c) => a.t - c.t);

            if (!upcoming.length) {
                container.innerHTML = '<div class="center-message">Brak nadchodzƒÖcych rezerwacji.</div>';
                return;
            }

            function renderBookingEntry(b) {
                const item = document.createElement('div');
                item.className = 'booking-item';
                item.style = 'padding:12px; border:1px solid rgba(255,255,255,0.04); margin-bottom:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; gap:12px;';

                const info = document.createElement('div');
                info.innerHTML = `
                    <div style="font-weight:600">${b.movie_title} ‚Äî Sala ${b.room_name}</div>
                    <div style="color:#ccc; font-size:13px">${(b.start_time ? parseTime(b.start_time).toLocaleString('pl-PL') : 'brak daty')} ‚Ä¢ Miejsce ${b.seat_number}</div>
                `;

                const actions = document.createElement('div');
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Anuluj';
                cancelBtn.style = 'padding:8px 10px; border-radius:6px; border:none; cursor:pointer; background: rgba(255,80,80,0.12); color:#fff;';
                cancelBtn.onclick = async () => {
                    const r = await fetch(`http://localhost:3000/api/bookings/${b.id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (r.ok) {
                        loadBookings();
                    } else {
                        alert('Nie uda≈Ço siƒô anulowaƒá.');
                    }
                };

                actions.appendChild(cancelBtn);
                item.appendChild(info);
                item.appendChild(actions);
                return item;
            }

            if (upcoming.length) {
                upcoming.forEach(({ b }) => container.appendChild(renderBookingEntry(b, false)));
            }

        } catch (err) {
            console.error(err);
            container.innerHTML = '<div class="center-message">B≈ÇƒÖd ≈Çadowania rezerwacji. Spr√≥buj ponownie p√≥≈∫niej.</div>';
        }
    }
    const userBtn = document.getElementById('userBtn');
const dropdown = document.getElementById('userDropdown');
const logoutBtn = document.getElementById('logoutBtn');

if (userBtn) {
    userBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.style.display =
            dropdown.style.display === 'flex' ? 'none' : 'flex';
    });
}
document.addEventListener('click', () => {
    if (dropdown) dropdown.style.display = 'none';
});

if (logoutBtn) {
  logoutBtn.onclick = () => {
    localStorage.removeItem('token');
    location.replace('index.html');
  };
}

    updateAuthLink();
    loadBookings();
</script>

</body>
</html>
