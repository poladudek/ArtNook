<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repertuar - ArtNook</title>
    <link rel="stylesheet" href="styles/style.css">
</head>
<body>

    <nav>
        <a class="name" href="index.html">ART NOOK</a>
        <div class="tabs">
            <a href="screenings.html">Repertuar</a>
            <a id="authLink" href="login.html">Zaloguj siƒô</a>
        </div>
    </nav>

    <h1 class="section-title">REPERTUAR</h1>

    <!-- USUNIƒòTO movies-scroll (slider) -->
    <div class="movies-container" id="moviesContainer">
        <div class="loading">≈Åadowanie film√≥w...</div>
    </div>

    <div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawer()" style="display:none"></div>

    <aside id="reservationDrawer" class="drawer">
        <div class="drawer-inner">
            <button class="drawer-close" onclick="closeDrawer()">&times;</button>

            <div class="drawer-header">
                <h2 class="modal-title" id="modalMovieTitle"></h2>
                <p class="modal-desc" id="modalMovieDesc"></p>
                <p class="modal-duration" id="modalMovieDuration"></p>
                <p class="modal-screening-info" id="modalScreeningInfo" style="font-weight:600;color:#ccc;margin-top:6px"></p>
            </div>

            <div class="screening-select">
                <label for="screeningSelect">Wybierz seans:</label>
                <select id="screeningSelect" onchange="loadSeats()">
                    <option value="">-- Wybierz termin seansu --</option>
                </select>
            </div>

            <div id="seatsSection" class="seats-section" style="display: none;">
                <div class="screen">Ekran</div>
                <div class="seats-grid" id="seatsGrid"></div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box available"></div>
                        <span>Dostƒôpne</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box selected"></div>
                        <span>Wybrane</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box booked"></div>
                        <span>Zajƒôte</span>
                    </div>
                </div>
            </div>

            <button class="reserve-btn" id="reserveBtn" onclick="reserveSeat()" disabled>
                ZAREZERWUJ MIEJSCE
            </button>

            <div id="message" style="display: none;"></div>
        </div>
    </aside>

    <script>
        let currentMovieId = null;
        let currentScreeningId = null;
        let selectedSeat = null;
        let allSeats = [];

        async function loadMovies() {
            try {
                const movies = (await (await fetch("http://localhost:3000/api/movies")).json()).data;

                const container = document.getElementById('moviesContainer');
                container.innerHTML = '';

                if (!movies.length) {
                    container.innerHTML = '<div class="loading">Brak dostƒôpnych film√≥w.</div>';
                    return;
                }

                movies.forEach(movie => {
                    const card = document.createElement("div");
                    card.classList.add("movie-card");
                    card.onclick = () => openReservationModal(movie);

                    const img = document.createElement("img");
                    img.classList.add("movie-poster");
                    img.src = `http://localhost:3000/${movie.img_path}`;
                    img.alt = movie.title;

                    const info = document.createElement("div");
                    info.classList.add("movie-info");

                    const title = document.createElement("h3");
                    title.classList.add("movie-title");
                    title.textContent = movie.title;

                    info.append(title);
                    card.append(img, info);
                    container.appendChild(card);
                });

            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania film√≥w:', err);
                document.getElementById('moviesContainer').innerHTML =
                    '<div class="loading">B≈ÇƒÖd ≈Çadowania film√≥w. Sprawd≈∫ po≈ÇƒÖczenie z serwerem.</div>';
            }
        }

        async function openReservationModal(movie) {
            currentMovieId = movie.id;
            document.getElementById('modalMovieTitle').textContent = movie.title;
            document.getElementById('modalMovieDesc').textContent = movie.description;
            document.getElementById('modalMovieDuration').textContent = `Czas trwania: ${movie.duration} min`;
            document.getElementById('drawerOverlay').style.display = 'block';
            document.getElementById('reservationDrawer').classList.add('open');
            document.getElementById('seatsSection').style.display = 'none';
            document.getElementById('message').style.display = 'none';
            document.getElementById('reserveBtn').disabled = true;

            await loadScreenings(movie.id);
        }

        async function loadScreenings(movieId) {
            try {
                const response = await fetch(`http://localhost:3000/api/screenings/full/${movieId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const screenings = await response.json();

                const select = document.getElementById('screeningSelect');
                select.innerHTML = '<option value="">Wybierz termin seansu</option>';

                screenings.forEach(screening => {
                    const option = document.createElement('option');
                    option.value = screening.id;
                    const date = new Date(screening.start_time);
                    option.textContent =
                        `${date.toLocaleDateString('pl-PL')} ${date.toLocaleTimeString('pl-PL', {hour:'2-digit',minute:'2-digit'})} ‚Äì Sala ${screening.room_name}`;
                    select.appendChild(option);
                });

            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania seans√≥w:', err);
                showMessage('B≈ÇƒÖd ≈Çadowania seans√≥w. Spr√≥buj ponownie.', 'error');
            }
        }

        async function loadSeats() {
            const screeningId = document.getElementById('screeningSelect').value;
            if (!screeningId) {
                document.getElementById('seatsSection').style.display = 'none';
                document.getElementById('reserveBtn').disabled = true;
                document.getElementById('modalScreeningInfo').textContent = '';
                return;
            }

            currentScreeningId = screeningId;
            selectedSeat = null;
            document.getElementById('reserveBtn').disabled = true;

            try {
                const response = await fetch(`http://localhost:3000/api/screenings/${screeningId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                const start = new Date(data.start_time);
                document.getElementById('modalScreeningInfo').textContent = `${start.toLocaleDateString('pl-PL')} ${start.toLocaleTimeString('pl-PL', {hour:'2-digit',minute:'2-digit'})} ‚Äî Sala ${data.room_name || ''}`;

                allSeats = data.seats || [];
                const totalSeats = Number(data.seats_total);

                const seatsGrid = document.getElementById('seatsGrid');
                seatsGrid.innerHTML = '';
                document.getElementById('seatsSection').style.display = 'block';

                for (let i = 1; i <= totalSeats; i++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.textContent = i;
                    seat.dataset.seatNumber = i;

                    const seatInfo = allSeats.find(s => parseInt(s.seat_number) === i);
                    if (seatInfo && seatInfo.is_booked) {
                        seat.classList.add('booked');
                    } else {
                        seat.onclick = () => selectSeat(i);
                    }

                    seatsGrid.appendChild(seat);
                }

            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania miejsc:', err);
                showMessage('B≈ÇƒÖd ≈Çadowania miejsc. Spr√≥buj ponownie.', 'error');
            }
        }

        function selectSeat(seatNumber) {
            document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
            const seatEl = document.querySelector(`[data-seat-number="${seatNumber}"]`);
            if (seatEl && !seatEl.classList.contains('booked')) {
                seatEl.classList.add('selected');
                selectedSeat = seatNumber;
                document.getElementById('reserveBtn').disabled = false;
            }
        }

        async function reserveSeat() {
            if (!selectedSeat || !currentScreeningId) return;

            document.getElementById('reserveBtn').disabled = true;

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showMessage('Musisz byƒá zalogowany, aby zarezerwowaƒá miejsce.', 'error');
                    document.getElementById('reserveBtn').disabled = false;
                    return;
                }

                const response = await fetch(
                    `http://localhost:3000/api/screenings/reserve/${currentScreeningId}/${selectedSeat}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );

                const payload = await response.json().catch(() => ({}));

                if (!response.ok) {
                    if (response.status === 409) {
                        showMessage('To miejsce jest ju≈º zajƒôte ‚Äî wybierz inne.', 'error');
                        await loadSeats();
                        return;
                    }
                    if (response.status === 401) {
                        showMessage('Musisz siƒô zalogowaƒá ponownie.', 'error');
                        return;
                    }
                    console.error('Reservation error:', payload);
                    showMessage('B≈ÇƒÖd rezerwacji. Spr√≥buj ponownie.', 'error');
                    return;
                }

                showMessage(`Miejsce ${selectedSeat} zosta≈Ço zarezerwowane!`, 'success');
                await loadSeats();

            } catch (err) {
                console.error('B≈ÇƒÖd rezerwacji:', err);
                showMessage('B≈ÇƒÖd rezerwacji. Spr√≥buj ponownie.', 'error');
            } finally {
                document.getElementById('reserveBtn').disabled = false;
            }
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            messageEl.className = 'message';
        }

        function closeDrawer() {
            document.getElementById('reservationDrawer').classList.remove('open');
            document.getElementById('drawerOverlay').style.display = 'none';
            document.getElementById('seatsSection').style.display = 'none';
            document.getElementById('screeningSelect').value = '';
            document.getElementById('message').style.display = 'none';
            selectedSeat = null;
            currentScreeningId = null;
            currentMovieId = null;
            document.getElementById('reserveBtn').disabled = true;
        }

        loadMovies();
        function updateAuthLink() {
            const authLink = document.getElementById('authLink');
            const token = localStorage.getItem('token');
            if (!authLink) return;
            if (token) {
                authLink.href = 'user.html';
                authLink.innerHTML = '<span class="user-icon">üë§</span>';
                authLink.title = 'Panel u≈ºytkownika';
            } else {
                authLink.href = 'login.html';
                authLink.textContent = 'Zaloguj siƒô';
            }
        }
        updateAuthLink();
    </script>

</body>
</html>
